#!/usr/bin/env bash
# ========================================
# PlebisHub Development Setup Script
# ========================================
# This script sets up the development environment
# ========================================

set -e

echo "===================================="
echo "PlebisHub Development Setup"
echo "===================================="
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if PostgreSQL is running
echo -e "${YELLOW}Checking PostgreSQL...${NC}"
if ! pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
  echo -e "${RED}ERROR: PostgreSQL is not running on localhost:5432${NC}"
  echo "Please start PostgreSQL service:"
  echo "  - Docker: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d db redis"
  echo "  - System: sudo service postgresql start"
  exit 1
else
  echo -e "${GREEN}✓ PostgreSQL is running${NC}"
fi

# Check if Redis is running
echo -e "${YELLOW}Checking Redis...${NC}"
if ! redis-cli -h localhost -p 6379 ping > /dev/null 2>&1; then
  echo -e "${YELLOW}WARNING: Redis is not running on localhost:6379${NC}"
  echo "Redis is optional for basic functionality but required for background jobs"
else
  echo -e "${GREEN}✓ Redis is running${NC}"
fi

# Load environment variables
if [ -f .env.development ]; then
  echo -e "${YELLOW}Loading environment variables from .env.development...${NC}"
  export $(cat .env.development | grep -v '^#' | xargs)
  echo -e "${GREEN}✓ Environment variables loaded${NC}"
else
  echo -e "${RED}ERROR: .env.development file not found${NC}"
  exit 1
fi

# Install dependencies
echo -e "${YELLOW}Installing Ruby dependencies...${NC}"
bundle install
echo -e "${GREEN}✓ Ruby dependencies installed${NC}"

# Setup database
echo -e "${YELLOW}Setting up database...${NC}"
bundle exec rails db:create db:migrate
echo -e "${GREEN}✓ Database created and migrated${NC}"

# Load seed data (optional)
read -p "Do you want to load seed data? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo -e "${YELLOW}Loading seed data...${NC}"
  bundle exec rails db:seed
  echo -e "${GREEN}✓ Seed data loaded${NC}"
fi

echo ""
echo -e "${GREEN}===================================="
echo "Setup completed successfully!"
echo "====================================${NC}"
echo ""
echo "To start the development server:"
echo "  bundle exec rails server"
echo ""
echo "Or to start with Puma:"
echo "  bundle exec puma -C config/puma.rb"
echo ""
