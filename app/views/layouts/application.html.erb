<!DOCTYPE html>
<html lang="<%= I18n.locale %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= yield(:title).presence || 'PlebisHub' %> | <%= Rails.application.config.site_name rescue 'PlebisBrand' %></title>

  <!-- Favicon (dynamic from brand settings) -->
  <link rel="shortcut icon" href="<%= brand_favicon_url %>" type="image/png">
  <link rel="icon" href="<%= brand_favicon_url %>" type="image/png">

  <!-- Resource Hints for Performance -->
  <%= dns_prefetch_tag('fonts.googleapis.com') %>
  <%= dns_prefetch_tag('fonts.gstatic.com') %>
  <%= preconnect_tag('https://fonts.googleapis.com') %>
  <%= preconnect_tag('https://fonts.gstatic.com', crossorigin: true) %>

  <!-- Preload Critical Resources (dynamic from brand settings) -->
  <%= brand_font_preload_tags %>

  <!-- Modern Fonts (dynamic from brand settings) -->
  <%= brand_font_link_tag %>

  <!-- CSRF Protection -->
  <%= csrf_meta_tags %>
  <%= csp_meta_tag rescue nil %>

  <!-- Stylesheets -->
  <% if vite_asset_available? %>
    <%= vite_stylesheet_tag 'application.css' rescue nil %>
  <% end %>
  <%= stylesheet_link_tag 'application', media: 'all' %>

  <!-- Brand Theme CSS Variables (injected from backend) -->
  <%= brand_style_tag %>
  <%= brand_meta_tags %>

  <!-- Open Graph / Social Meta -->
  <meta property="og:title" content="<%= yield(:og_title).presence || 'PlebisBrand | Portal de participación' %>">
  <meta property="og:description" content="<%= yield(:og_description).presence || @meta_description %>">
  <meta property="og:image" content="<%= yield(:og_image).presence || @meta_image %>">
  <meta property="og:type" content="website">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= yield(:twitter_title).presence || 'PlebisBrand | Portal de participación' %>">
  <meta name="twitter:description" content="<%= yield(:twitter_description).presence || @meta_description %>">
  <meta name="twitter:image" content="<%= yield(:twitter_image).presence || @meta_image %>">

  <!-- Analytics (production only) -->
  <% if Rails.env.production? %>
    <%= render partial: 'shared/tag_manager_head' rescue render(partial: 'tag_manager_head') rescue nil %>
  <% end %>
</head>
<body class="<%= body_class(user_signed_in?, controller_name, action_name) %> antialiased">
  <div id="app" class="wrap min-h-screen flex flex-col">
    <%= render partial: 'shared/header' rescue render(partial: 'header') %>

    <main class="content flex-1">
      <%= render partial: 'shared/flash_messages' rescue render(partial: 'flash_boxes') %>
      <%= yield %>
    </main>

    <%= render partial: 'shared/footer' rescue render(partial: 'footer') %>
  </div>

  <!-- Cookie Consent -->
  <%= render partial: 'shared/cookie_consent' rescue render(partial: 'cookie_policy') %>

  <!-- JavaScript -->
  <% if vite_asset_available? %>
    <%= vite_javascript_tag 'application' rescue nil %>
  <% end %>
  <%= javascript_include_tag 'application', defer: true %>

  <!-- Service Worker Registration (Production) -->
  <% if Rails.env.production? %>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
              console.log('SW registered:', registration.scope);
            })
            .catch(function(error) {
              console.log('SW registration failed:', error);
            });
        });
      }
    </script>
  <% end %>

  <!-- Analytics (production only) -->
  <% if Rails.env.production? %>
    <%= render partial: 'shared/tag_manager_body' rescue render(partial: 'tag_manager_body') rescue nil %>
    <%= render partial: 'shared/facebook_pixel' rescue render(partial: 'facebook_pixel') rescue nil %>
  <% end %>
</body>
</html>
